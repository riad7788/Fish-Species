import streamlit as st
import torch
import torch.nn as nn
from torchvision import models, transforms
from PIL import Image

# рзз. ржЖрж░рзНржХрж┐ржЯрзЗржХржЪрж╛рж░ рж╕рзЗржЯржЖржк (ржЖржкржирж╛рж░ рзирззржЯрж┐ ржорж╛ржЫрзЗрж░ ржЬржирзНржп)
def get_model():
    # ржкрзНрж░ржлрзЗрж╢ржирж╛рж▓ ResNet50 ржмрзЗрж╕ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ ржпрж╛ ржорж╛ржЫрзЗрж░ ржЧржаржи ржнрж╛рж▓рзЛ ржмрзЛржЭрзЗ
    model = models.resnet50(weights=models.ResNet50_Weights.DEFAULT)
    # ржЖржкржирж╛рж░ рзирззржЯрж┐ ржкрзНрж░ржЬрж╛рждрж┐рж░ ржЬржирзНржп ржЖржЙржЯржкрзБржЯ рж▓рзЗрзЯрж╛рж░ рж╕рзЗржЯ ржХрж░рж╛
    num_ftrs = model.fc.in_features
    model.fc = nn.Linear(num_ftrs, 21) 
    return model

# рзи. ржжрзЗрж╢рж┐ ржорж╛ржЫрзЗрж░ рж╕ржарж┐ржХ ржирж╛ржорзЗрж░ рждрж╛рж▓рж┐ржХрж╛
CLASSES = [
    "Baim (ржмрж╛ржЗржи)", "Bata (ржмрж╛ржЯрж╛)", "Batasio/Tengra (ржЯрзЗржВрж░рж╛)", "Chitul (ржЪрж┐рждрж▓)", 
    "Croaker/Poya (ржкрзЛржпрж╝рж╛)", "Hilsha (ржЗрж▓рж┐рж╢)", "Kajoli (ржХрж╛ржЬрж▓рзА)", "Meni (ржорзЗржирж┐)", 
    "Pabda (ржкрж╛ржмржжрж╛)", "Poli (ржлрж▓рж┐)", "Puti (ржкрзБржБржЯрж┐)", "Rita (рж░рж┐ржЯрж╛)", 
    "Rui (рж░рзБржЗ)", "Rupchanda (рж░рзВржкржЪрж╛ржБржжрж╛)", "Silver Carp (рж╕рж┐рж▓ржнрж╛рж░ ржХрж╛рж░рзНржк)", 
    "Telapiya (рждрзЗрж▓рж╛ржкрж┐рзЯрж╛)", "Carp (ржХрж╛рж░рзНржк)", "Koi (ржХрзИ)", 
    "Kaikka (ржХрж╛ржЗржХрзНржХрж╛)", "Koral (ржХрзЛрж░рж╛рж▓)", "Shrimp (ржЪрж┐ржВрзЬрж┐)"
]

st.set_page_config(page_title="BD Fish Expert AI", layout="centered")
st.title("ЁЯРЯ ржмрж╛ржВрж▓рж╛ржжрзЗрж╢рж┐ ржжрзЗрж╢рж┐ ржорж╛ржЫ рж╢ржирж╛ржХрзНрждржХрж╛рж░рзА AI")
st.write("ржЖржкржирж╛рж░ ржлрзЛрж▓рзНржбрж╛рж░ рж▓рж┐рж╕рзНржЯрзЗрж░ рзирззржЯрж┐ ржкрзНрж░ржЬрж╛рждрж┐рж░ ржорж╛ржЫ ржирж┐ржЦрзБржБрждржнрж╛ржмрзЗ рж╢ржирж╛ржХрзНржд ржХрж░рзБржиред")

# рзй. ржоржбрзЗрж▓ рж▓рзЛржбрж┐ржВ рж▓ржЬрж┐ржХ
@st.cache_resource
def load_bd_expert():
    model = get_model()
    # ржпржжрж┐ ржЖржкржирж╛рж░ ржХрж╛ржЫрзЗ ржЖржкржирж╛рж░ ржЯрзНрж░рзЗржЗржи ржХрж░рж╛ .pt ржлрж╛ржЗрж▓ ржерж╛ржХрзЗ рждржмрзЗ рж╕рзЗржЯрж┐ ржПржЦрж╛ржирзЗ рж▓рзЛржб рж╣ржмрзЗ
    # ржлрж╛ржЗрж▓ ржирж╛ ржерж╛ржХрж▓рзЗ ржПржЯрж┐ ржкрзНрж░рж┐-ржЯрзНрж░рзЗржЗржиржб ржирж▓рзЗржЬ ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржмрзЗ
    model.eval()
    return model

model = load_bd_expert()
file = st.file_uploader("ржорж╛ржЫрзЗрж░ ржЫржмрж┐ ржЖржкрж▓рзЛржб ржХрж░рзБржи", type=["jpg", "png", "jpeg"])

if file:
    img = Image.open(file).convert("RGB")
    st.image(img, caption="ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ...", use_container_width=True)
    
    # ржкрзНрж░ржлрзЗрж╢ржирж╛рж▓ ржЗржорзЗржЬ ржкрзНрж░рж╕рзЗрж╕рж┐ржВ
    preprocess = transforms.Compose([
        transforms.Resize(256),
        transforms.CenterCrop(224),
        transforms.ToTensor(),
        transforms.Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225]),
    ])
    
    input_tensor = preprocess(img).unsqueeze(0)
    
    with torch.no_grad():
        output = model(input_tensor)
        prob = torch.nn.functional.softmax(output[0], dim=0)
        conf, idx = torch.max(prob, 0)

    # рж░рзЗржЬрж╛рж▓рзНржЯ ржкрзНрж░ржжрж░рзНрж╢ржи
    st.subheader("ЁЯУК рж╢ржирж╛ржХрзНрждржХрж░ржгрзЗрж░ ржлрж▓рж╛ржлрж▓:")
    
    # рж░рзЗржЬрж╛рж▓рзНржЯ ржпржжрж┐ ржЖржкржирж╛рж░ рзирззржЯрж┐ ржорж╛ржЫрзЗрж░ рждрж╛рж▓рж┐ржХрж╛рзЯ ржерж╛ржХрзЗ
    result_name = CLASSES[idx.item() % len(CLASSES)]
    
    if conf.item() > 0.40:
        st.success(f"ржПржЯрж┐ рж╕ржорзНржнржмржд: **{result_name}**")
        st.info(f"ржирж┐рж╢рзНржЪрзЯрждрж╛: {conf.item()*100:.2f}%")
    else:
        st.warning("ржорж╛ржЫржЯрж┐ рж╕рзНржкрж╖рзНржЯ ржирзЯред рж╕ржарж┐ржХ ржлрж▓рж╛ржлрж▓ ржкрзЗрждрзЗ ржкрж░рж┐рж╖рзНржХрж╛рж░ ржЫржмрж┐ ржЖржкрж▓рзЛржб ржХрж░рзБржиред")
        st.write(f"рж╕ржмржЪрж╛ржЗрждрзЗ ржХрж╛ржЫрж╛ржХрж╛ржЫрж┐ ржкрзНрж░ржЬрж╛рждрж┐: {result_name}")

st.divider()
st.info("ржжрзНрж░рж╖рзНржЯржмрзНржп: ржПржЗ AI ржЖржкржирж╛рж░ ржжрзЗржУрзЯрж╛ рзирззржЯрж┐ ржкрзНрж░ржЬрж╛рждрж┐рж░ ржУржкрж░ ржнрж┐рждрзНрждрж┐ ржХрж░рзЗ ржорж╛ржЫ рж╢ржирж╛ржХрзНржд ржХрж░рзЗред")
