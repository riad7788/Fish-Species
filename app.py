import streamlit as st
from transformers import pipeline
from PIL import Image

# рзз. ржкрзНрж░ржлрзЗрж╢ржирж╛рж▓ ржоржбрзЗрж▓ рж▓рзЛржб (рж╕ржмржЪрзЗрзЯрзЗ ржЖржзрзБржирж┐ржХ ржнрж╛рж░рзНрж╕ржи)
@st.cache_resource
def load_bd_fish_model():
    # ржПржЗ ржоржбрзЗрж▓ржЯрж┐ ржорж╛ржЫрзЗрж░ рж╕рзВржХрзНрж╖рзНржо ржмрзИрж╢рж┐рж╖рзНржЯрзНржпржЧрзБрж▓рзЛ ржнрж╛рж▓рзЛ ржмрзЛржЭрзЗ
    return pipeline("image-classification", model="google/vit-base-patch16-224")

# рзи. ржмрж╛ржВрж▓рж╛ржжрзЗрж╢рж┐ ржмрж╛ржЬрж╛рж░рзЗрж░ ржорж╛ржЫрзЗрж░ ржорж╛рж╕рзНржЯрж╛рж░ ржорзНржпрж╛ржкрж┐ржВ
# ржПржЦрж╛ржирзЗ ржЗржВрж░рзЗржЬрж┐ рж▓рзЗржмрзЗрж▓ ржЕржирзБржпрж╛рзЯрзА ржжрзЗрж╢рж┐ ржирж╛ржоржЧрзБрж▓рзЛ рж╕рзЗржЯ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ
BD_MARKET_FISH = {
    "carp": "рж░рзБржЗ, ржХрж╛рждрж▓рж╛ ржмрж╛ ржХрж╛рж░рзНржк ржЬрж╛рждрзАрзЯ ржорж╛ржЫ",
    "catfish": "ржкрж╛ржЩрж╛рж╢, рж╢рж┐ржВ, ржорж╛ржЧрзБрж░ ржмрж╛ ржЖржЗрзЬ ржорж╛ржЫ",
    "barracouta": "ржмрзЛрзЯрж╛рж▓ ржмрж╛ ржмрзНржпрж╛рж░рж╛ржХрзБржбрж╛ ржЬрж╛рждрзАрзЯ ржорж╛ржЫ", # ржЖржкржирж╛рж░ ржмрзЛрзЯрж╛рж▓ ржорж╛ржЫрзЗрж░ ржЬржирзНржп ржлрж┐ржХрзНрж╕
    "eel": "ржмрж╛ржЗржи ржмрж╛ ржХрзБржБржЪрзЗ ржорж╛ржЫ",
    "tilapia": "рждрзЗрж▓рж╛ржкрж┐рзЯрж╛ ржорж╛ржЫ",
    "goldfish": "ржЧрзЛрж▓рзНржбржлрж┐рж╢ (ржПржХрзБрж░рж┐ржпрж╝рж╛ржо)",
    "tench": "рж╢рж┐ржВ ржмрж╛ ржорж╛ржЧрзБрж░",
    "gar": "ржХрж╛ржЙрзЯрж╛ ржмрж╛ ржХрж╛ржЗржХрзНржХрж╛ ржорж╛ржЫ",
    "puffer": "ржкржЯржХрж╛ ржорж╛ржЫ",
    "clownfish": "рж░ржЩрж┐ржи ржорж╛ржЫ",
    "perch": "ржХрзИ ржмрж╛ ржнрзЗржЯржХрж┐ ржЬрж╛рждрзАрзЯ ржорж╛ржЫ",
    "herring": "ржЗрж▓рж┐рж╢ ржмрж╛ ржЪрзНржпрж╛ржкрж╛ рж╢рзБржБржЯржХрж┐ ржЬрж╛рждрзАрзЯ ржорж╛ржЫ",
    "salmon": "рж╕рзНржпрж╛ржоржи ржмрж╛ ржмрзЬ рж╕рж╛ржорзБржжрзНрж░рж┐ржХ ржорж╛ржЫ",
    "stingray": "рж╢рж╛ржкрж▓рж╛ржкрж╛рждрж╛ ржорж╛ржЫ",
    "shrimp": "ржЪрж┐ржВрзЬрж┐ ржорж╛ржЫ",
    "lobster": "ржЧрж▓ржжрж╛ ржЪрж┐ржВрзЬрж┐"
}

st.set_page_config(page_title="BD Fish Expert", page_icon="ЁЯРЯ")
st.title("ЁЯРЯ ржмрж╛ржВрж▓рж╛ржжрзЗрж╢рж┐ ржмрж╛ржЬрж╛рж░ ржорж╛ржЫ рж╢ржирж╛ржХрзНрждржХрж╛рж░рзА (Pro)")
st.write("ржмрж╛ржЬрж╛рж░рзЗрж░ ржпрзЗржХрзЛржирзЛ ржорж╛ржЫрзЗрж░ ржЫржмрж┐ рждрзБрж▓рзБржи, AI ржЖржкржирж╛ржХрзЗ ржжрзЗрж╢рж┐ ржирж╛ржо ржмрж▓рзЗ ржжрзЗржмрзЗред")

with st.spinner('ржкрзНрж░ржлрзЗрж╢ржирж╛рж▓ AI ржЗржЮрзНржЬрж┐ржи ржЪрж╛рж▓рзБ рж╣ржЪрзНржЫрзЗ...'):
    classifier = load_bd_fish_model()

file = st.file_uploader("ржорж╛ржЫрзЗрж░ ржЫржмрж┐ ржжрж┐ржи (Market Photo)", type=["jpg", "png", "jpeg"])

if file:
    img = Image.open(file).convert("RGB")
    st.image(img, caption="ржЖржкржирж╛рж░ ржЖржкрж▓рзЛржб ржХрж░рж╛ ржЫржмрж┐", use_container_width=True)
    
    with st.spinner('ржорж╛ржЫржЯрж┐ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ...'):
        results = classifier(img)
    
    st.subheader("ЁЯУК рж╢ржирж╛ржХрзНржд ржХрж░рж╛ ржлрж▓рж╛ржлрж▓:")
    
    # ржкрзНрж░ржержо рж░рзЗржЬрж╛рж▓рзНржЯржЯрж┐ ржпржжрж┐ ржжрзЗрж╢рж┐ рж▓рж┐рж╕рзНржЯрзЗ ржерж╛ржХрзЗ рждржмрзЗ рж╕рзЗржЯрж┐ ржмрзЬ ржХрж░рзЗ ржжрзЗржЦрж╛ржмрзЗ
    top_result = results[0]
    top_label = top_result['label'].split(',')[0].lower()
    top_score = top_result['score']
    
    bd_name = BD_MARKET_FISH.get(top_label, top_label.capitalize())
    
    # ржмрзЬ рж╣рж╛ржЗрж▓рж╛ржЗржЯ ржмржХрзНрж╕
    st.info(f"рж╕ржмржЪрж╛ржЗрждрзЗ ржмрзЗрж╢рж┐ рж╕ржорзНржнрж╛ржмржирж╛: **{bd_name}** ({top_score*100:.2f}%)")
    
    # ржЕржирзНржпрж╛ржирзНржп рж╕ржорзНржнрж╛ржмржирж╛
    with st.expander("ржЖрж░ржУ ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд ржжрзЗржЦрзБржи"):
        for res in results:
            label = res['label'].split(',')[0].lower()
            score = res['score']
            name = BD_MARKET_FISH.get(label, label.capitalize())
            st.write(f"**{name}**: {score*100:.2f}%")
            st.progress(score)
