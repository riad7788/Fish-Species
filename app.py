import streamlit as st
from transformers import pipeline
from PIL import Image

# рзз. ржкрзНрж░ржлрзЗрж╢ржирж╛рж▓ ржоржбрзЗрж▓ рж▓рзЛржб ржХрж░рж╛
@st.cache_resource
def load_professional_model():
    return pipeline("image-classification", model="google/vit-base-patch16-224")

# рзи. ржЗржВрж░рзЗржЬрж┐ ржирж╛ржо ржерзЗржХрзЗ ржмрж╛ржВрж▓рж╛ржжрзЗрж╢рж┐ ржирж╛ржорзЗрж░ ржбрж┐ржХрж╢ржирж╛рж░рж┐ (ржорзНржпрж╛ржкрж┐ржВ)
# ржПржЦрж╛ржирзЗ ржЖржкржирж┐ ржЖржкржирж╛рж░ ржкржЫржирзНржжржорждрзЛ ржЖрж░ржУ ржирж╛ржо ржпрзЛржЧ ржХрж░рждрзЗ ржкрж╛рж░рзЗржи
FISH_NAMES_BN = {
    "tench": "рж╢рж┐ржВ ржмрж╛ ржорж╛ржЧрзБрж░ ржЬрж╛рждрзАрзЯ ржорж╛ржЫ",
    "goldfish": "ржЧрзЛрж▓рзНржбржлрж┐рж╢",
    "great white shark": "рж╣рж╛ржЩрж░",
    "tiger shark": "рж╣рж╛ржЩрж░",
    "hammerhead": "рж╣рж╛рждрзБрзЬрж┐ рж╣рж╛ржЩрж░",
    "electric ray": "рж╢рж╛ржкрж▓рж╛ржкрж╛рждрж╛ ржорж╛ржЫ",
    "stingray": "рж╢рж╛ржкрж▓рж╛ржкрж╛рждрж╛ ржорж╛ржЫ",
    "barracouta": "ржмрзНржпрж╛рж░рж╛ржХрзБржбрж╛",
    "eel": "ржмрж╛ржЗржи ржорж╛ржЫ",
    "coho": "рж╕рзНржпрж╛ржоржи ржорж╛ржЫ",
    "rock beauty": "рж░ржЩрж┐ржи ржорж╛ржЫ",
    "anemone fish": "ржЕрзНржпрж╛ржирж┐ржорзЛржирж┐ ржорж╛ржЫ",
    "sturgeon": "рж╕рзНржЯрж╛рж░рзНржЬржи",
    "gar": "ржЧрж╛ржЗржХрзНржХрж╛ ржмрж╛ ржХрзБржБржЪрзЗ ржорж╛ржЫ",
    "lionfish": "рж▓рж╛рзЯржи ржлрж┐рж╢",
    "puffer": "ржкржЯржХрж╛ ржорж╛ржЫ",
    "carp": "рж░рзБржЗ ржмрж╛ ржХрж╛рж░рзНржк ржЬрж╛рждрзАрзЯ ржорж╛ржЫ",
    "catfish": "ржорж╛ржЧрзБрж░ ржмрж╛ рж╢рж┐ржВ ржорж╛ржЫ",
    "tilapia": "рждрзЗрж▓рж╛ржкрж┐рзЯрж╛",
    "clownfish": "ржХрзНрж▓рж╛ржЙржи ржлрж┐рж╢"
}

st.set_page_config(page_title="Bangladeshi Fish AI", page_icon="ЁЯРЯ")
st.title("ЁЯРЯ ржмрж╛ржВрж▓рж╛ржжрзЗрж╢рж┐ ржорж╛ржЫ рж╢ржирж╛ржХрзНрждржХрж╛рж░рзА AI")
st.write("ржЫржмрж┐ ржЖржкрж▓рзЛржб ржХрж░рзБржи ржПржмржВ ржмрж╛ржВрж▓рж╛ржжрзЗрж╢рж┐ ржирж╛ржо ржжрзЗржЦрзБржиред")

with st.spinner('AI рждрзИрж░рж┐ рж╣ржЪрзНржЫрзЗ...'):
    classifier = load_professional_model()

uploaded_file = st.file_uploader("ржорж╛ржЫрзЗрж░ ржЫржмрж┐ ржЖржкрж▓рзЛржб ржХрж░рзБржи", type=["jpg", "png", "jpeg"])

if uploaded_file:
    img = Image.open(uploaded_file).convert("RGB")
    st.image(img, use_container_width=True)
    
    with st.spinner('ржорж╛ржЫржЯрж┐ ржЪрзЗржирж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░ржЫрж┐...'):
        results = classifier(img)
    
    st.success("### ржлрж▓рж╛ржлрж▓ (рж╕ржорзНржнрж╛ржмрзНржп ржирж╛ржо):")
    
    for res in results:
        eng_name = res['label'].split(',')[0].lower() # ржЗржВрж░рзЗржЬрж┐ ржирж╛ржо
        score = res['score']
        
        # ржпржжрж┐ ржбрж┐ржХрж╢ржирж╛рж░рж┐рждрзЗ ржмрж╛ржВрж▓рж╛ржжрзЗрж╢рж┐ ржирж╛ржо ржерж╛ржХрзЗ рждржмрзЗ рж╕рзЗржЯрж┐ ржжрзЗржЦрж╛ржмрзЗ, ржирж╛рж╣рж▓рзЗ ржЗржВрж░рзЗржЬрж┐ ржирж╛ржоржЗ ржжрзЗржЦрж╛ржмрзЗ
        bangla_name = FISH_NAMES_BN.get(eng_name, eng_name.capitalize())
        
        st.write(f"**{bangla_name}** ({score*100:.2f}%)")
        st.progress(score)
